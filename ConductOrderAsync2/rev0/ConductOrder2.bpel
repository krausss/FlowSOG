<!-- ConductOrder2 BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Mon Nov 14 14:09:43 CET 2016 -->
<bpel:process name="ConductOrder2" targetNamespace="sog"
	suppressJoinFailure="yes" xmlns:tns="sog"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:ns="http://iaas.uni-stuttgart.de/labs/FlowSOG" xmlns:sog="http://www.w3.org/2001/XMLSchema">

	<!-- Import the client WSDL -->
	<bpel:import namespace="http://iaas.uni-stuttgart.de/labs/FlowSOG"
		location="ShopServices.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
	<bpel:import location="ConductOrder2Artifacts.wsdl"
		namespace="sog" importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- ================================================================= -->
	<!-- PARTNERLINKS -->
	<!-- List of services participating in this BPEL process -->
	<!-- ================================================================= -->
	<bpel:partnerLinks>
		<!-- The 'client' role represents the requester of this service. -->
		<bpel:partnerLink name="client" partnerLinkType="tns:ConductOrder2"
			myRole="ConductOrder2Provider" />
		<bpel:partnerLink name="InventoryPL" partnerLinkType="tns:InventoryPLT"
			partnerRole="InventoryRole"></bpel:partnerLink>
		<bpel:partnerLink name="OrderPL" partnerLinkType="tns:OrderPLT"
			partnerRole="OrderRole"></bpel:partnerLink>
		<bpel:partnerLink name="ShipmentPL" partnerLinkType="tns:ShipmentPLT"
			partnerRole="ShipmentRole"></bpel:partnerLink>
		<bpel:partnerLink name="PaymentPL" partnerLinkType="tns:PaymentPLT"
			partnerRole="PaymentRole"></bpel:partnerLink>
		<bpel:partnerLink name="InventoryCallbackPL"
			partnerLinkType="tns:InventoryCallbackPLT" myRole="InventoryCallbackRole"></bpel:partnerLink>
	</bpel:partnerLinks>

	<!-- ================================================================= -->
	<!-- VARIABLES -->
	<!-- List of messages and XML documents used within this BPEL process -->
	<!-- ================================================================= -->
	<bpel:variables>
		<!-- Reference to the message passed as input during initiation -->
		<bpel:variable name="input" messageType="tns:ConductOrder2RequestMessage" />

		<!-- Reference to the message that will be returned to the requester -->
		<bpel:variable name="output" messageType="tns:ConductOrder2ResponseMessage" />



		<bpel:variable name="checkAvailabilityResponse"
			messageType="ns:checkAvailabilityOutput"></bpel:variable>
		<bpel:variable name="checkAvailabilityRequest"
			messageType="ns:checkAvailabilityInput"></bpel:variable>
		<bpel:variable name="storeOrderDetailsRequest"
			messageType="ns:storeOrderDetailsInput"></bpel:variable>
		<bpel:variable name="storeOrderDetailsResponse"
			messageType="ns:storeOrderDetailsOutput"></bpel:variable>
		<bpel:variable name="calcOrderCostsRequest" messageType="ns:calcOrderCostsInput"></bpel:variable>
		<bpel:variable name="calcOrderCostsResponse"
			messageType="ns:calcOrderCostsOutput"></bpel:variable>
		<bpel:variable name="calcShipmentCostsRequest"
			messageType="ns:calcShipmentCostsInput"></bpel:variable>
		<bpel:variable name="calcShipmentCostsResponse"
			messageType="ns:calcShipmentCostsOutput"></bpel:variable>


		<bpel:variable name="calcTransactionCostsRequest"
			messageType="ns:calcTransactionCostsInput"></bpel:variable>
		<bpel:variable name="calcTransactionCostsResponse"
			messageType="ns:calcTransactionCostsOutput"></bpel:variable>


		<bpel:variable name="conductPaymentRequest" messageType="ns:conductPaymentInput"></bpel:variable>
		<bpel:variable name="conductPaymentResponse"
			messageType="ns:conductPaymentOutput"></bpel:variable>
		<bpel:variable name="shipProductsRequest" messageType="ns:shipProductsInput"></bpel:variable>
		<bpel:variable name="shipProductsResponse" messageType="ns:shipProductsOutput"></bpel:variable>
		<bpel:variable name="checkAvailabilityAsyncRequest"
			messageType="ns:checkAvailabilityAsyncInput"></bpel:variable>


		<bpel:variable name="InventoryCallbackRequest"
			messageType="ns:onFinishCheckAvailabilityInput"></bpel:variable>
		<bpel:variable name="cancelOrderRequest" messageType="ns:cancelOrderInput"></bpel:variable>
	</bpel:variables>

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:correlationSets>
		<bpel:correlationSet name="AsyncCOCorrelationSet"
			properties="tns:customerID"></bpel:correlationSet>
	</bpel:correlationSets>
	<bpel:sequence name="main"><!-- Receive input from requester. Note: 
			This maps to operation defined in ConductOrder2.wsdl -->
		<bpel:receive name="receiveInput" partnerLink="client"
			portType="tns:ConductOrder2" operation="process" variable="input"
			createInstance="yes" />

		<!-- Generate reply to synchronous request -->


























		<bpel:flow name="Flow">
			<bpel:sequence>



				<bpel:assign validate="no" name="PrepareInvoke">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:checkAvailabilityAsync
									xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:callbackUrl>tns:callbackUrl</tns:callbackUrl>
									<tns:customerId>tns:customerId</tns:customerId>
									<tns:productId>tns:productId</tns:productId>
								</tns:checkAvailabilityAsync>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="checkAvailabilityAsyncRequest" part="checkAvailabilityAsyncInput"></bpel:to>
					</bpel:copy>




					<bpel:copy>
						<bpel:from>
                            
                        
                            
                            
                            
                            
                            
                            
                            <![CDATA[bpel:doXslTransform("inputTransformation.xsl", $input.payload/tns:input)]]>
						</bpel:from>
						<bpel:to part="checkAvailabilityAsyncInput" variable="checkAvailabilityAsyncRequest"></bpel:to>


					</bpel:copy>




				</bpel:assign>
				<bpel:invoke name="InvokeCheckAvailability" partnerLink="InventoryPL"
					operation="checkAvailabilityAsync" portType="ns:InventoryPortType"
					inputVariable="checkAvailabilityAsyncRequest">
					<bpel:correlations>
						<bpel:correlation set="AsyncCOCorrelationSet"
							initiate="yes"></bpel:correlation>
					</bpel:correlations>
				</bpel:invoke>




				<bpel:receive name="Receive" partnerLink="InventoryCallbackPL"
					operation="onFinishCheckAvailability" portType="ns:InventoryCallbackPortType"
					variable="InventoryCallbackRequest">
					<bpel:correlations>
						<bpel:correlation set="AsyncCOCorrelationSet"
							initiate="no"></bpel:correlation>
					</bpel:correlations>
				</bpel:receive>
			</bpel:sequence>
			<bpel:sequence name="Sequence">


				<bpel:assign validate="no" name="AssignOrderDetails">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:storeOrderDetails
									xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:orderId>tns:orderId</tns:orderId>
									<tns:customerId>tns:customerId</tns:customerId>
									<tns:products>
										<tns:product>
											<tns:productId>tns:productId</tns:productId>
											<tns:numberOfItems>0</tns:numberOfItems>
										</tns:product>
									</tns:products>
									<tns:shippingAddress>tns:shippingAddress</tns:shippingAddress>
									<tns:paymentDetails>
										<tns:bankName>tns:bankName</tns:bankName>
										<tns:bankAddress>tns:bankAddress</tns:bankAddress>
										<tns:accountNumber>tns:accountNumber</tns:accountNumber>
										<tns:accountHolderName>tns:accountHolderName
										</tns:accountHolderName>
									</tns:paymentDetails>
									<tns:status>ordered</tns:status>
								</tns:storeOrderDetails>
							</bpel:literal>

						</bpel:from>
						<bpel:to variable="storeOrderDetailsRequest" part="storeOrderDetailsInput"></bpel:to>


					</bpel:copy>
					<bpel:copy>
						<bpel:from part="payload" variable="input">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:input/tns:products]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="storeOrderDetailsInput" variable="storeOrderDetailsRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:products]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="payload" variable="input">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:input/tns:shippingAddress]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="storeOrderDetailsInput" variable="storeOrderDetailsRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:shippingAddress]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="payload" variable="input">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:input/tns:paymentDetails]]></bpel:query>
						</bpel:from>
						<bpel:to part="storeOrderDetailsInput" variable="storeOrderDetailsRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:paymentDetails]]></bpel:query>
						</bpel:to>
					</bpel:copy>





				</bpel:assign>
				<bpel:invoke name="InvokeStoreOrderDetails" partnerLink="OrderPL"
					operation="storeOrderDetails" portType="ns:OrderPortType"
					inputVariable="storeOrderDetailsRequest" outputVariable="storeOrderDetailsResponse"></bpel:invoke>
				<bpel:assign validate="no" name="AssignOrderId">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:cancelOrder xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:orderId>tns:orderId</tns:orderId>
								</tns:cancelOrder>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="cancelOrderRequest" part="cancelOrderInput"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:shipProducts xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:orderId>tns:orderId</tns:orderId>
									<tns:date>2001-01-01</tns:date>
								</tns:shipProducts>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="shipProductsRequest" part="shipProductsInput"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:conductPayment xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:orderId>tns:orderId</tns:orderId>
									<tns:amount>0.0</tns:amount>
								</tns:conductPayment>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="conductPaymentRequest" part="conductPaymentInput"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:calcTransactionCosts
									xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:orderId>tns:orderId</tns:orderId>
								</tns:calcTransactionCosts>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="calcTransactionCostsRequest" part="calcTransactionCostsInput"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:calcShipmentCosts
									xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:orderId>tns:orderId</tns:orderId>
								</tns:calcShipmentCosts>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="calcShipmentCostsRequest" part="calcShipmentCostsInput"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:calcOrderCosts xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:orderId>tns:orderId</tns:orderId>
								</tns:calcOrderCosts>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="calcOrderCostsRequest" part="calcOrderCostsInput"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="storeOrderDetailsOutput" variable="storeOrderDetailsResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:from>
						<bpel:to part="calcOrderCostsInput" variable="calcOrderCostsRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="storeOrderDetailsOutput" variable="storeOrderDetailsResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:from>
						<bpel:to part="calcShipmentCostsInput" variable="calcShipmentCostsRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:to>
					</bpel:copy>

					<bpel:copy>
						<bpel:from part="storeOrderDetailsOutput" variable="storeOrderDetailsResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:from>
						<bpel:to part="calcTransactionCostsInput" variable="calcTransactionCostsRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="storeOrderDetailsOutput" variable="storeOrderDetailsResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:from>
						<bpel:to part="conductPaymentInput" variable="conductPaymentRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="storeOrderDetailsOutput" variable="storeOrderDetailsResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:from>
						<bpel:to part="shipProductsInput" variable="shipProductsRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:to>
					</bpel:copy>

					<bpel:copy>
						<bpel:from part="storeOrderDetailsOutput" variable="storeOrderDetailsResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:from>
						<bpel:to part="cancelOrderInput" variable="cancelOrderRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:flow name="CostCalculationFlow">
					<bpel:invoke name="InvokeCalcOrderCosts" partnerLink="OrderPL"
						operation="calcOrderCosts" portType="ns:OrderPortType"
						inputVariable="calcOrderCostsRequest" outputVariable="calcOrderCostsResponse">
					</bpel:invoke>
					<bpel:invoke name="InvokeCalcTransactionCosts"
						partnerLink="PaymentPL" operation="calcTransactionCosts" portType="ns:PaymentPortType"
						inputVariable="calcTransactionCostsRequest" outputVariable="calcTransactionCostsResponse"></bpel:invoke>
					<bpel:invoke name="InvokeCalcShipmentCosts"
						partnerLink="ShipmentPL" operation="calcShipmentCosts" portType="ns:ShipmentPortType"
						inputVariable="calcShipmentCostsRequest" outputVariable="calcShipmentCostsResponse"></bpel:invoke>
				</bpel:flow>

			</bpel:sequence>

		</bpel:flow>
		<bpel:if name="IfNotAvailable">
			<bpel:condition><![CDATA[count($InventoryCallbackRequest.onFinishCheckAvailabilityInput/ns:productList/ns:product[ns:status/ns:currentAvailability != "available"]) != 0 ]]></bpel:condition>

			<bpel:sequence>
                
                
                <bpel:invoke name="InvokeCancelOrder" partnerLink="OrderPL" operation="cancelOrder" portType="ns:OrderPortType" inputVariable="cancelOrderRequest"></bpel:invoke>
                <bpel:assign validate="no" name="AssignOutput">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:ConductOrder2Response xmlns:tns="sog"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:result>tns:result</tns:result>
								</tns:ConductOrder2Response>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="output" part="payload"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
                            <![CDATA["One or more products you ordered are currently not available. Please try again later."]]>
						</bpel:from>
						<bpel:to part="payload" variable="output">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:result]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:reply name="Reply" partnerLink="client" operation="process"
					portType="tns:ConductOrder2" variable="output"></bpel:reply>
                
                <bpel:exit name="Exit"></bpel:exit>
			</bpel:sequence>
		</bpel:if>


		<bpel:assign validate="no" name="AssignTotalCosts">
			<bpel:copy>
				<bpel:from>
					<bpel:literal>
						<tns:conductPayment xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG"
							xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
							<tns:orderId>tns:orderId</tns:orderId>
							<tns:amount>0.0</tns:amount>
						</tns:conductPayment>
					</bpel:literal>
				</bpel:from>
				<bpel:to variable="conductPaymentRequest" part="conductPaymentInput"></bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from>
                    <![CDATA[$calcOrderCostsResponse.calcOrderCostsOutput/ns:orderCosts + $calcShipmentCostsResponse.calcShipmentCostsOutput/ns:shipmentCosts + $calcTransactionCostsResponse.calcTransactionCostsOutput/ns:transactionCosts]]>
				</bpel:from>
				<bpel:to part="conductPaymentInput" variable="conductPaymentRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:amount]]></bpel:query>
				</bpel:to>
			</bpel:copy>


		</bpel:assign>
		<bpel:invoke name="InvokeConductPayment" partnerLink="PaymentPL"
			operation="conductPayment" portType="ns:PaymentPortType"
			inputVariable="conductPaymentRequest" outputVariable="conductPaymentResponse"></bpel:invoke>

		<bpel:invoke name="InvokeShipProducts" partnerLink="ShipmentPL"
			operation="shipProducts" portType="ns:ShipmentPortType"
			inputVariable="shipProductsRequest" outputVariable="shipProductsResponse"></bpel:invoke>
		<bpel:assign validate="no" name="AssignOutput">
			<bpel:copy>
				<bpel:from>
					<bpel:literal>
						<tns:ConductOrder2Response xmlns:tns="sog"
							xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
							<tns:result>tns:result</tns:result>
						</tns:ConductOrder2Response>
					</bpel:literal>
				</bpel:from>
				<bpel:to part="payload" variable="output">
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="shipProductsOutput" variable="shipProductsResponse"></bpel:from>
				<bpel:to part="payload" variable="output">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:result]]>
					</bpel:query>
				</bpel:to>
			</bpel:copy>
		</bpel:assign>
		<bpel:reply name="replyOutput" partnerLink="client"
			portType="tns:ConductOrder2" operation="process" variable="output" />






	</bpel:sequence>
</bpel:process>

